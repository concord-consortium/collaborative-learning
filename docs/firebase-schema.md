# Realtime Database DB Schema

The core design elements of the schema are:

1. The top level keys are `test`, `dev`, `qa`, `demo` and `authed` where `test` and `dev` use subkeys based on the user id to create unique environments per DB user.  Unit tests automatically delete any data added.
2. Under the top level keys is the `portals` key with sub-keys under `portals` for each portal domain found during authentication.  Since qa, demo, and dev do not use the portal, it is just set to `qa`, `demo`, or `localhost` for these modes. All data except for user data will live under a portal domain.
3. All objects will have a version property.
4. Any object that can be loaded as a list should contain the minimum amount of metadata to display the information on the UI with id references to larger objects.
5. All read-only write-once data (such as "publications") will be stored using DB storage.

## Hierarchy

```text
/(dev|qa|test|demo|authed)
  [<firebaseUserId> if dev or test, <demoId> for demo]
    /portals
      /<escapedPortalDomain> or "qa", "demo", "localhost"
        /users {key: uid => DBPortalUser}
          version: "1.0"
          /self
            uid: string
          latestGroupId: string
          /documentMetadata {key: documentKey => DBDocumentMetadata}
            version: "1.0"
            /self
              uid: string
              documentKey: string
            createdAt: number (timestamp)
            editedAt: number (timestamp)
            type: "section" | "learningLog"
            classHash?: string
            offeringId?: string
            evaluation {key: aiEvaluation from config file}
              number (timestamp)
            // TDB: serialized document model metadata
          /documents: {key: documentKey => DBDocument}
            version: "1.0"
            /self
              documentKey: string
              uid: string
            TDB: serialized document model contents
          /learningLogs {key: documentKey => DBLearningLog}
            version: "1.0"
            /self
              documentKey: string
              uid: string
            title: string
        /classes {key: classHash => DBClass}
          version: "1.0"
          /self
            classHash: string
          /offerings: {key: offeringId => DBOffering}
            version: "1.0"
            /self
              classHash: string
              offeringId: string
            /users {key: uid => DBOfferingUser}
              version: "1.0"
              /self
                classHash: string
                offeringId: string
                uid: string
              TDB: store ui information here?
              /sectionDocuments {key: sectionId => DBOfferingUserSectionDocument}
                version: "1.0"
                /self
                  classHash: string
                  offeringId: string
                  uid: string
                  sectionId: string
                visibility: "public" | "private"
                documentKey: string
            /groups {key: groupId => DBOfferingGroup}
              version: "1.0"
              /self
                classHash: string
                offeringId: string
                groupId: string
              /users {key: uid => DBOfferingGroupUser}
                version: "1.0"
                /self
                  classHash: string
                  offeringId: string
                  groupId: string
                  uid: string
                connectedTimestamp: number
                disconnectedTimestamp: number

NOTES:

  1. escapedPortalDomain is the DB escaped hostname of the domain in the portal JWT. TODO: get escapedPortalDomain is DB JWT claims.
  2. uid is a numeric user id from the portal JWT
  3. classHash is a string from the portal JWT
  4. documentKey is generated by DB pushes to the documents reference
```

## Interfaces

All interfaces can be found in `lib/db-types.ts`.
